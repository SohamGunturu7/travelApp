{% extends 'base.html' %}

{% block title %}Map View - Travel Planner{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .map-error {
        color: red;
        padding: 20px;
        text-align: center;
    }
    .mapboxgl-popup {
        max-width: 300px;
    }
    .mapboxgl-popup-content {
        padding: 15px;
    }
    .mapboxgl-popup-content h6 {
        margin: 0 0 5px 0;
        color: #0d6efd;
    }
    .mapboxgl-popup-content p {
        margin: 0;
        color: #6c757d;
    }
    .mapboxgl-marker {
        cursor: pointer;
    }
    .back-button {
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="card-title mb-0">
                            {% if day_number %}
                                Day {{ day_number }} Activities in {{ destination.name }}
                            {% else %}
                                Interactive Map
                            {% endif %}
                        </h2>
                        <a href="{% url 'view_itinerary' itinerary_id %}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Itinerary
                        </a>
                    </div>
                    <div id="map"></div>
                    <div id="map-error" class="map-error" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

<script>
    // Debug information
    console.log('Mapbox Access Token:', '{{ mapbox_access_token|default:"null" }}');
    console.log('Destination:', '{{ destination.name|default:"Unknown" }}');
    console.log('Destination Coordinates:', '{{ destination.coordinates.lng|default:"0" }}', '{{ destination.coordinates.lat|default:"0" }}');
    
    // Convert activities to a safe JSON string
    const activitiesData = {{ activities|safe }};
    console.log('Activities:', activitiesData);

    try {
        // Initialize MapBox
        mapboxgl.accessToken = '{{ mapbox_access_token|default:"" }}';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [{{ destination.coordinates.lng|default:"0" }}, {{ destination.coordinates.lat|default:"0" }}], // Center on destination
            zoom: 12 // Zoom level for city view
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());

        // Add geolocation control
        map.addControl(
            new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                trackUserLocation: true,
                showUserHeading: true
            })
        );

        // Wait for the map to load
        map.on('load', function() {
            console.log('Map loaded successfully');
            
            // Create a GeoJSON source for markers
            const markers = {
                type: 'FeatureCollection',
                features: []
            };

            // Create a GeoJSON source for the route
            const route = {
                type: 'Feature',
                properties: {},
                geometry: {
                    type: 'LineString',
                    coordinates: []
                }
            };

            // Process activities and add them to the map
            activitiesData.forEach((activity, index) => {
                if (activity.location && activity.location !== 'null') {
                    console.log('Processing activity:', activity.activity, 'Location:', activity.location);
                    const coords = activity.location.split(',').map(Number);
                    const lng = coords[0];
                    const lat = coords[1];

                    // Add marker for activity
                    markers.features.push({
                        type: 'Feature',
                        properties: {
                            title: activity.activity,
                            description: activity.time,
                            order: index + 1
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: [lng, lat]
                        }
                    });

                    // Add point to route
                    route.geometry.coordinates.push([lng, lat]);
                }
            });

            console.log('Markers:', markers);
            console.log('Route:', route);

            // Add markers source and layer
            map.addSource('markers', {
                type: 'geojson',
                data: markers
            });

            // Add custom marker images
            map.loadImage('https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png', function(error, image) {
                if (error) throw error;
                map.addImage('custom-marker', image);
                
                // Add marker layer
                map.addLayer({
                    id: 'markers',
                    type: 'symbol',
                    source: 'markers',
                    layout: {
                        'icon-image': 'custom-marker',
                        'icon-size': 0.8,
                        'text-field': ['get', 'order'],
                        'text-font': ['Open Sans Bold'],
                        'text-size': 16,
                        'text-offset': [0, 1.25],
                        'text-anchor': 'top',
                        'text-allow-overlap': true
                    },
                    paint: {
                        'text-color': '#ffffff',
                        'text-halo-color': '#000000',
                        'text-halo-width': 2
                    }
                });
            });

            // Add route source and layer
            map.addSource('route', {
                type: 'geojson',
                data: route
            });

            map.addLayer({
                id: 'route',
                type: 'line',
                source: 'route',
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#3b82f6',
                    'line-width': 4,
                    'line-opacity': 0.7
                }
            });

            // Add route numbers
            map.addLayer({
                id: 'route-numbers',
                type: 'symbol',
                source: 'route',
                layout: {
                    'symbol-placement': 'line-center',
                    'text-field': ['get', 'order'],
                    'text-font': ['Open Sans Bold'],
                    'text-size': 14,
                    'text-allow-overlap': true
                },
                paint: {
                    'text-color': '#ffffff',
                    'text-halo-color': '#3b82f6',
                    'text-halo-width': 2
                }
            });

            // Add popups to markers
            map.on('click', 'markers', function(e) {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const properties = e.features[0].properties;
                
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }
                
                new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(`
                        <h6>${properties.title}</h6>
                        <p class="mb-0">${properties.description}</p>
                    `)
                    .addTo(map);
            });

            // Change cursor to pointer when hovering over markers
            map.on('mouseenter', 'markers', function() {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'markers', function() {
                map.getCanvas().style.cursor = '';
            });

            // Fit map to show all markers and route
            if (markers.features.length > 0) {
                const bounds = new mapboxgl.LngLatBounds();
                markers.features.forEach(function(feature) {
                    bounds.extend(feature.geometry.coordinates);
                });
                map.fitBounds(bounds, {
                    padding: 50
                });
            }
        });

        // Handle map errors
        map.on('error', function(e) {
            console.error('Map error:', e);
            document.getElementById('map-error').style.display = 'block';
            document.getElementById('map-error').textContent = 'Error loading map: ' + e.error;
        });

    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('map-error').style.display = 'block';
        document.getElementById('map-error').textContent = 'Error initializing map: ' + error.message;
    }
</script>
{% endblock %} 