{% extends 'base.html' %}

{% block title %}Map View - Travel Planner{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .mapboxgl-popup {
        max-width: 300px;
    }
    
    .mapboxgl-popup-content {
        padding: 1rem;
    }
    
    .activity-time {
        font-weight: bold;
        color: #0d6efd;
    }
    
    .activity-description {
        font-size: 0.9rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="card-title mb-4">
                        {% if day_number %}
                            Day {{ day_number }} Activities in {{ destination.name }}
                        {% else %}
                            Interactive Map
                        {% endif %}
                    </h2>
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

<script>
    // Initialize MapBox
    mapboxgl.accessToken = '{{ mapbox_access_token }}';
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [{{ destination.coordinates.lng }}, {{ destination.coordinates.lat }}], // Center on destination
        zoom: 12 // Zoom level for city view
    });

    // Add navigation controls
    map.addControl(new mapboxgl.NavigationControl());

    // Add geolocation control
    map.addControl(
        new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true,
            showUserHeading: true
        })
    );

    // Wait for the map to load
    map.on('load', function() {
        {% if activities %}
            const activities = {{ activities|safe }};
            const coordinates = [];
            const markers = [];
            
            // Add destination marker
            const destinationMarker = new mapboxgl.Marker({
                color: '#28a745' // Green color for destination
            })
            .setLngLat([{{ destination.coordinates.lng }}, {{ destination.coordinates.lat }}])
            .setPopup(
                new mapboxgl.Popup({ offset: 25 })
                .setHTML(`
                    <div>
                        <h5 class="mb-2">{{ destination.name }}</h5>
                        <p class="text-muted small">Your destination</p>
                    </div>
                `)
            )
            .addTo(map);
            
            // Add markers for each activity
            activities.forEach((activity, index) => {
                if (activity.location) {
                    const coords = activity.location.split(',').map(coord => parseFloat(coord.trim()));
                    
                    // Create a marker
                    const marker = new mapboxgl.Marker({
                        color: '#0d6efd'
                    })
                    .setLngLat(coords)
                    .setPopup(
                        new mapboxgl.Popup({ offset: 25 })
                        .setHTML(`
                            <div>
                                <h6 class="activity-time">${activity.time}</h6>
                                <h5 class="mb-2">${activity.activity}</h5>
                                ${activity.description ? `<p class="activity-description">${activity.description}</p>` : ''}
                            </div>
                        `)
                    )
                    .addTo(map);
                    
                    markers.push(marker);
                    coordinates.push(coords);
                }
            });
            
            // If we have coordinates, fit the map bounds to show all markers
            if (coordinates.length > 0) {
                const bounds = coordinates.reduce((bounds, coord) => {
                    return bounds.extend(coord);
                }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
                
                // Include destination in bounds
                bounds.extend([{{ destination.coordinates.lng }}, {{ destination.coordinates.lat }}]);
                
                map.fitBounds(bounds, {
                    padding: 50,
                    maxZoom: 15
                });
                
                // If we have more than one location, add a route line
                if (coordinates.length > 1) {
                    map.addSource('route', {
                        'type': 'geojson',
                        'data': {
                            'type': 'Feature',
                            'properties': {},
                            'geometry': {
                                'type': 'LineString',
                                'coordinates': coordinates
                            }
                        }
                    });
                    
                    map.addLayer({
                        'id': 'route',
                        'type': 'line',
                        'source': 'route',
                        'layout': {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        'paint': {
                            'line-color': '#0d6efd',
                            'line-width': 3,
                            'line-dasharray': [2, 2]
                        }
                    });
                }
            }
        {% endif %}
    });
</script>
{% endblock %} 